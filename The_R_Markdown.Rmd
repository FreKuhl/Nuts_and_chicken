---
title: "Nuts and chicken"
author: "Lukas Gürtler & Frederik Kuhl"
output: html_document
bibliography: 
  - bib/references.bib 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(decisionSupport)
library(tidyverse)
library(knitr)
library(readxl)
library(rmarkdown)
```

```{r add_R_bib, include=FALSE}
knitr::write_bib(c(.packages(),
                   'knitr', 'decisionSupport'), 'bib/packages.bib')
```

This supplementary is available under <https://github.com/FreKuhl/Nuts_and_chicken.git> and outlines the Decision Analysis approaches used in Model-based evaluation of management options in ornamental plant nurseries [@ruett_model-based_2020]. Here we provide our input table, code and results to allow for transparent reproduction of the model.

All other applied `R` packages are cited and listed in the [References].

## Input table
The input table `Input_estimates.xlsx` (attached) contains: Variable names, unit, distributions (posnorm = positive normal distribution, const = constant, tnorm_0_1= truncated normal distribution, norm = normal distribution), lower bound, mean, upper bound and definition of variables.

## Implementing the model in R

Here we provide our mathematical model that enables simulation of decision outcomes.
The calculations in this document are based on random draws from the distributions in the input table `Input_estimates.csv`. Explanations for code chunks are not part of the actual simulation. 

Load the input table `Input_file.csv` and make variables.
```{r eval= FALSE}
input_estimates <- read_excel("input_estimates.xlsx")

make_variables <- function(est,n=1)
{ x <- random(rho=est, n=n)
for(i in colnames(x)) assign(i, as.numeric(x[1,i]),envir = .GlobalEnv)}

make_variables(as.estimate(input_estimates))
```

We generated a function called `model_function` to evaluate the decision options in `decisionSupport` [@luedelingDecisionSupportQuantitativeSupport2019]. The following calculations are part of this function (see the entire function below). 
```{r eval= FALSE}
model_function <- function() {}
```

We used the `vv()` (value varier function) function from `decisionSupport` [@luedelingDecisionSupportQuantitativeSupport2019] to account for the monthly variation in infection risks.
Here it is used to generate values out of variables pre-defined upper and lower bounds over time.

## The scenarios
The investments and risks that are made independently of the scenarios have been grouped together under #General. This variables are the variance of nut prices, the cance of losses due to frost, the amount of subsidies, the initial planting of grass and setting up and maintaining fences.
```{r eval= FALSE}
# General ----
  
  full_yield_period <- years - 8
  
  nuts_frost <- chance_event(
    chance = late_frost,
    value_if = 0.3,
    value_if_not = 1,
    n = years)
  
  nut_price <- vv(var_mean = nut_price,
                  var_CV = 20,
                  n = years)
  
  subsidies_vec <- vv(var_mean = subsidies,
                  var_CV = 1,
                  n = years)
  
  general_investments_vec <- vv(var_mean = maintaining_fences_cost,
                                var_CV = 30,
                                n = years)
  
  ###
  general_investments_vec[1] <- general_investments_vec[1] + 
    grass_planting_cost + initial_fences_cost
```    
    
### The baseline scenario
The baseline scenario describes the current situation on the plot and is used to compare the different decisions with the current state. The plot is used as arable land and its income consists of a crop rotation with different cultures. The income in the different years varies annually, as in the other scenarios. The different cultures are winterbarley, rye, wheat and sommerbarley. They are all calculated like the example below and added up over the period of 30 years into vectors for each model run.
```{r eval= FALSE}
 winterbarley_yield_vec <- vv(var_mean = winterbarley_yield,
                               var_CV = 10,
                               n = years)
  winterbarley_costs_vec <- vv(var_mean = winterbarley_costs,
                               var_CV = 5,
                               n = years)
  winterbarley_work_vec <- vv(var_mean = winterbarley_work,
                              var_CV = 5,
                              n = years)
  winterbarley_price_vec <- vv(var_mean = winterbarley_price,
                               var_CV = 10,
                               n = years)
  
  winterbarley_income_vec <- (winterbarley_yield_vec * winterbarley_price_vec) -
    (winterbarley_costs_vec + (winterbarley_work_vec * working_hours_costs))
```

### Scenario 1
Scenario 1 consists of a hazelnut plantation with 70 trees spaced in rows of 10 meters. The plantation is irrigated with a drip system and additionally hay is produced between the rows of trees. In addition to the plantation, 200 chickens are kept with a chicken mobile. 

For each branch of the income we calculated the yields and the cost. The Code below shows this for the Nuts yield of scenario 1 and 4.
```{r eval= FALSE}
 # Yield Nuts ----
  # For Versions 1 and 4

nuts_1 <- gompertz_yield(
    max_harvest = nut_yield_1,
    time_to_first_yield_estimate = 6,
    first_yield_estimate_percent = 40,
    time_to_second_yield_estimate = 10,
    second_yield_estimate_percent = 100,
    n_years = years,
    var_CV = 10)
  
  nuts_yield_vec_1 <- nuts_1 * nuts_frost
  
  harvest_count_1 <- ifelse(nuts_yield_vec_1 < 20, 0, 1)
  
  amount_bales <- vv(var_mean = amount_bales_1,
                     var_CV = 10,
                     n = years)
  
  income_per_bale <- vv(var_mean = income_bale_1,
                        var_CV = 10,
                        n = years)
  
  income_hay <- amount_bales * income_per_bale
  
  ###
  nut_income_vec_1_4 <- (nuts_yield_vec_1 * nut_price) + income_hay
  
  
  # Nuts Costs ----
  # For Versions 1 and 4
  
  maintaining_tree_h_vec_1 <- vv(var_mean = maintaining_trees_h_1,
                                 var_CV = 15,
                                 n = years)
  
  maintaining_tree_h_vec_1[8:full_yield_period] <- 
    maintaining_tree_h_vec_1[8:full_yield_period] * maintaining_trees_factor
  
  nut_harvest_h_vec_1 <- vv(var_mean = nut_harvest_hours_1,
                            var_CV = 5,
                            n = years)
  
  nut_harvest_h_vec_1 <- nut_harvest_h_vec_1 * harvest_count_1
  
  nut_mulch_h_vec_1 <- vv(var_mean = mulch_h_1,
                          var_CV = 5,
                          n = years)
  
  other_nut_h_1 <- vv(var_mean = other_nut_h_1,
                      var_CV = 5,
                      n = years)
  
  nut_h_vec_1 <- maintaining_tree_h_vec_1 + nut_harvest_h_vec_1 + 
    nut_mulch_h_vec_1 + other_nut_h_1
  
  nut_h_vec_1[1] <- nut_h_vec_1[1] + tree_planting_hours_1
  
  nut_workcosts_vec_1 <- nut_h_vec_1 * working_hours_costs
  
  nut_other_costs_vec_1 <- vv(var_mean = nut_var_costs_1,
                              var_CV = 20,
                              n = years)
  
  nut_other_costs_vec_1[1] <- nut_other_costs_vec_1[1] + tree_planting_costs_1
  
  harvest_nets_1 <- vv(var_mean = harvest_nets_1,
                       var_CV = 1,
                       n = years)
  
  harvest_nets_1[] <- harvest_nets_1 *
    c(TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE)
  
  nut_other_costs_vec_1 <- nut_other_costs_vec_1 + harvest_nets_1
  
  nut_other_costs_vec_1[1] <- nut_other_costs_vec_1[1] + tree_planting_costs_1
  
  nut_other_costs_vec_4 <- nut_other_costs_vec_1
  
  nut_other_costs_vec_4[1] <- 
    nut_other_costs_vec_4[1] + truffle_tree_planting_costs_1
  
  hay_costs <- vv(var_mean = hay_costs_1,
                  var_CV = 5,
                  n = years)
  
  replace_trees_1 <- chance_event(chance = 0.1,
                                  value_if = 3,
                                  value_if_not = 0,
                                  n = years,
                                  CV_if = 30)
  
  replace_trees_1 <- replace_trees_1 * replacing_trees_cost
  
  replace_trees_4 <- replace_trees_1 * replacing_truffle_trees_cost
```

### Scenario 2
Scenario 2 consists of a hazelnut plantation with 200 trees, which stand at a distance of 5 meters, this is irrigated by a drip system and also here 200 chickens are kept with a chicken mobile. 

As all the plantations in our model are irrigated the code below shows the calculation for irrigation in scenario 2 and 5.
```{r eval= FALSE}
 # Irrigation ----
  
  days_irrigation <- vv(var_mean = days_to_irrigate,
                        var_CV = 60,
                        n = years)
  
  days_irrigation[days_irrigation < 10] <- 10
  
  days_irrigation[days_irrigation > 55] <- 55
  
  irrigation_h_vec <- days_irrigation * work_per_irrigation
  
  # For Versions 2 and 5
  
  irrigation_installation_2 <- water_trailer + installation_irrigation_2
  
  water_usage_vec_2 <- days_irrigation * water_per_day_2
  
  trailer_refills_vec_2 <- water_usage_vec_2 / trailer_capacity
  
  trailer_refills_vec_2 <- trailer_refills_vec_2 + 3
  
  refill_h_vec_2 <- trailer_refills_vec_2 * work_per_trailer
  
  irrigation_h_vec_2 <- refill_h_vec_2 + irrigation_h_vec
  
  irrigation_costs_2 <- irrigation_h_vec_2 * working_hours_costs
  
  maintaining_irrigation_2 <- vv(var_mean = maintaining_irrigation_2,
                                 var_CV = 10,
                                 n = years)
  
  water_costs_2 <- water_usage_vec_2 * water_price
  
  irrigation_costs_2_5 <- 
    irrigation_costs_2 + maintaining_irrigation_2 + water_costs_2
  
  ###
  irrigation_costs_2_5[1] <- irrigation_costs_2_5[1] + irrigation_installation_2
```

### Scenario 3
Scenario 3 consists of 200 trees of different species, which are additionally infected with truffles and are not to be harvested. Also here 200 chickens are kept with a chicken mobile. As there is no nut harvest in this scenario we used a different way of calculating the cost for maintenance.
```{r eval= FALSE}
# Version 3
  
  maintaining_tree_h_vec_3 <- vv(var_mean = maintaining_trees_h_3,
                                 var_CV = 15,
                                 n = years)
  
  nut_mulch_h_vec_3 <- vv(var_mean = mulch_h_3,
                          var_CV = 5,
                          n = years)
  
  tree_h_vec <- maintaining_tree_h_vec_3 + nut_mulch_h_vec_3
  
  tree_h_vec[1] <- tree_h_vec[1] + tree_planting_hours_3
  
  tree_other_costs_vec <- vv(var_mean = tree_var_costs,
                             var_CV = 20,
                             n = years)
  
  tree_other_costs_vec[1] <- tree_other_costs_vec[1] + tree_planting_costs_3
```

In this scenario the irrigation is done by a trailer that needs to be refilled and is manually driven over the meadow.
```{r eval= FALSE}
# Truffle irrigation for 3
  
  days_irrigation_truffle <- vv(var_mean = truffle_days_to_irrigate,
                        var_CV = 60,
                        n = years)
  
  days_irrigation_truffle[days_irrigation_truffle < 20] <- 20
  
  days_irrigation_truffle[days_irrigation_truffle > 70] <- 70
  
  
  truffle_irrigation_h_vec <- days_irrigation_truffle * work_per_irrigation
  
  water_usage_vec_truffle <- days_irrigation_truffle * truffle_water_per_day
  
  trailer_refills_vec_truffle <- water_usage_vec_truffle / trailer_capacity
  
  trailer_refills_vec_truffle <- trailer_refills_vec_truffle + 3
  
  refill_h_vec_truffle <- trailer_refills_vec_truffle * work_per_trailer
  
  irrigation_h_vec_truffle <- refill_h_vec_truffle + truffle_irrigation_h_vec
  
  irrigation_costs_truffle <- irrigation_h_vec_truffle * working_hours_costs
  
  maintaining_irrigation_truffle <- vv(var_mean = maintaining_irrigation_2,
                                 var_CV = 10,
                                 n = years)
  
  water_costs_truffle <- water_usage_vec_truffle * water_price
  
  irrigation_costs_truffle <- 
    irrigation_costs_truffle + maintaining_irrigation_truffle + water_costs_truffle
  
  irrigation_costs_truffle[1] <- 
    irrigation_costs_truffle[1] + irrigation_installation_2
  
  ###
  truffle_final_vec_3 <- 
    truffle_income - truffle_harvest_costs - irrigation_costs_truffle
  ###
```

### Scenario 4
Scenario 4 is exactly the same as scenario 1, but the trees are additionally infected with truffles. The code below shows the way truffle yield and income are calculated in scenario 3,4 and 5.
```{r eval= FALSE}
# Truffle ----
  # For Version 3, 4 and 5
  
  truffle <- gompertz_yield(
    max_harvest = truffle_yield,
    time_to_first_yield_estimate = 5,
    first_yield_estimate_percent = 10,
    time_to_second_yield_estimate = 15,
    second_yield_estimate_percent = 100,
    n_years = years,
    var_CV = 60,
  )
  
  truffle_price <- vv(var_mean = truffle_price,
                      var_CV = 10,
                      n = years)
  
  truffle_income <- truffle * truffle_price
  
  truffle_harvest_costs <- vv(var_mean = truffle_harvest_costs,
                              var_CV = 5,
                              n = years)
  
  truffle_harvest_costs[1:5] <- 0
  
  ###
  truffle_final_vec_4_5 <- truffle_income - truffle_harvest_costs
  ###
```

### Scenario 5
Scenario 5 is exactly the same as scenario 2, but the trees are additionally infected with truffles.

The income generated by chicken eggs is the same in all the scenarios.
```{r eval= FALSE}
# Chicken ----
  # For Version 1, 2, 3, 4 and 5
  
  if (number_of_chicken == 50){
    
    initial_chicken_costs_final_2 <-
      (number_of_chicken * chicken_replacement_cost) + initial_chicken_mobile_cost_2
    
    maintaining_chicken_mobile_vec <- vv(var_mean = maintaining_chicken_mobile_2,
                                           var_CV = 15,
                                           n = years)
    
    maintaining_chicken_mobile_vec[1] <-
      maintaining_chicken_mobile_vec[1] + initial_chicken_costs_final_2
    
    working_hours_chicken <- vv(var_mean = working_hours_chicken_2,
                                var_CV = 10,
                                n = years)
    
  } else if (number_of_chicken == 200) {
    
    initial_chicken_costs_final_1 <-
      (number_of_chicken * chicken_replacement_cost) + initial_chicken_mobile_cost_1
    
    maintaining_chicken_mobile_vec <- vv(var_mean = maintaining_chicken_mobile_1,
                                           var_CV = 15,
                                           n = years)
    
    maintaining_chicken_mobile_vec[1] <-
      maintaining_chicken_mobile_vec[1] + initial_chicken_costs_final_1
    
    working_hours_chicken <- vv(var_mean = working_hours_chicken_1,
                                var_CV = 10,
                                n = years)
    
  } else {
    print("Number of chicken wrong")
  }
  
  
  chicken_feed_vec <- vv(var_mean = feed_per_hen,
                     var_CV = 5,
                     n = years)
  
  feed_cost_vec <- vv(var_mean = feed_cost,
                  var_CV = 10,
                  n = years)
  
  feed_cost_final_vec <- number_of_chicken * (chicken_feed_vec * feed_cost_vec)
  
  working_costs_chicken_final <-
    working_hours_chicken * working_hours_costs
  
  chicken_replacement <- vv(var_mean = number_of_chicken,
                            var_CV = 2,
                            n = years)
  
  # setting every second year to zero starting with the first 
  chicken_replacement[] <- chicken_replacement * c(FALSE, TRUE)
  
  chicken_replacement_cost_final <-
    chicken_replacement * chicken_replacement_cost
  
  # Income
  
  # Number of eggs per Year
  eggs_per_year <- vv(var_mean = egg_per_hen,
                      var_CV = 2,
                      n = years)
  
  eggs_per_year <- eggs_per_year * number_of_chicken
  
  #
  eggs_price <- vv(
    var_mean = eggs_price,
    var_CV = 5,
    n = years,
    lower_limit = 0.2
  )
  
  eggs_income <- eggs_per_year * eggs_price
  
  chicken_income <-
    eggs_income - (
      maintaining_chicken_mobile_vec + feed_cost_final_vec +
        working_costs_chicken_final + chicken_replacement_cost_final
    )
```

# Results

## Explaining Results/Values

Running the model produces a different outputs who are defined in the return list of the `model_function`. In this case it includes the accumulated income values for each scenario for the whole time-period, a vector with annual distribution of income for each scenario as well as different calculated decisions. Additionally the amount of sequestered CO2 is considered as an output.
The raw model-results of each scenario, including the baseline, is shown in the Graph 1. 
On the X-Axis the possible revenue distribution in € is displayed. The Y-Axis displays the probability density how likely one certain amount of revenue is likely. If the Curve for a scenario is wide, it means that the the degree of uncertainty is high, the possible revenue range is large. The smaller the curve is, the scenario is more defined and it is of a higher certainty that the displayed revenue is reached.
The baseline has the smallest curve, which means that this base-scenario is, compared to the other scenarios, well defined. This is because normal crop land is a well known and researched system with comparable few components who affect the income. The more aspects are added to a system, the uncertainty adds up and the distribution curve grows. Also single components with a high uncertainty, such as the truffles, add uncertainty to the whole system. This is also visible in Graph 1, the systems including nuts, chicken and truffle have the widest distribution curve. The very left side of a curve is the chance of getting always the worst part of the range of every input factor. If the  ranges for the input factors are chosen right, this is the point of the lowest possible income or highest possible loss. The very right side is the opposite, always the best part of the range of the input factors occur. So its the maximal possible revenue.
Based on the Curves for every scenario, different decisions can be modeled and conclusions can be drawn. The `decisionSupport` [@luedelingDecisionSupportQuantitativeSupport2019] Package also allows provides additional in depth analysis tools. They were also used for the evaluation of the results in this chapter.

## In depth analysis

Graph 1 shows that most likely every scenario will produce a positive overall income over a period of 30 years. Even so with every scenario there is also a chance of producing an overall loss. The current status of the area of interest is conventional crop land, this is the baseline. 

### Decisions
In order to determine whether or not one of the five agroforestry scenarios will be more profitable compared to the baseline, the baseline is in Graph 2 subtracted from each of the five scenarios. Graph 2 is therefor no longer just presenting the distribution of income but its presenting how much the decision of switching from the baseline to one of the scenarios is worth. Because the accumulated income of the 

## Conclusions

### Improvements

# References